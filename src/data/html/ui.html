<html>
<head>
	<title>Windfall UI html file</title>

	<script src="js/jquery.min.js" type="text/javascript"></script>
	<script src="js/kendo.web.js" type="text/javascript"></script>

	<link href="styles/kendo.common.min.css" rel="stylesheet" type="text/css" />
	<link href="styles/kendo.black.min.css" rel="stylesheet" type="text/css" />
	<link href="styles/windfall.css" rel="stylesheet" type="text/css" />
	<link href="styles/scroll.css" rel="stylesheet" type="text/css" />
	<style>
	#content,#wrapper {
		position: absolute;
		left:0; right:0;
		top:0; bottom: 0;
		background: transparent;
		overflow: hidden;
	}
	#topMenuBar {
		opacity: 0.9;
		z-index: +22222;
		height: 33px; /* also change #content, below */
		position:absolute;left:0;right:0;top:0;
	}
	#content { top: 33px; }
	#consoleWindow ul.log {
		position: absolute; left:0;right:0;top:0;bottom:2em;
		margin: .1em .3em .5em .5em;
		overflow: auto;
	}
	#consoleMessage {
		position: absolute;
		left:0; right:0; bottom: 0; height: 2em;
		background: #666;
	}
	#consoleInputBar {
		position:absolute; left:0;right:0;bottom:1px;height:2em;
	}
	#consoleInputBar input {
		position:absolute; left:0.3em;bottom:0.1em;top:0.1em;right:1.5em;height:1.8em; border: 1px solid black;
	}
	</style>
</head>
<body class="Windfall">

<div id="wrapper">
	<ul id="topMenuBar"></ul>
	<div id="content" class="k-content">
		<div id="consoleWindow">
		<ul class="log">
			<li>console log goes here...</li>
		</ul>
		<div id="consoleInputBar"><input type="text"/></div>
		</div>
	</div>

	<div id="consoleMessage"></div>
</div>

<script>
$(document).ready(function() {

	window.runningInBrowser = "undefined" == typeof(UI);

	if (runningInBrowser) UI = {};

	var onMenuItemSelected = function(e) {
		var t = $(e.item).children(".k-link").text();
		console.log("Top Menu Item Selected: " + t);
		switch(t) {
			case "Quit":
				console.log("Quitting");
				UI.Quit();
			break;
			case "Console":
				$('#consoleWindow').data("kendoWindow").open();
				setTimeout(scrollToBottomOfConsole, 100);
				$('#consoleInputBar input').focus();
			break;
			default:
				console.log("Unknown menu item: " + t);
			break;
		}
	}

	$("#topMenuBar").kendoMenu({
		dataSource: [
			{ text: "Test menu",
				items: [
					{ text: "test1" },
					{ text: "test two" }
				]
			},
			{ text: "Console" },
			{ text: "Quit" }
		],
		select: onMenuItemSelected
	});

	var consoleWindow = $('#consoleWindow');
	if (!consoleWindow.data("kendoWindow")) {
		consoleWindow.kendoWindow({
			title: "Debug console",
			width: "900px",
			height: "500px",
			minWidth: 220,
			minHeight: 120,
			actions: ["Maximize","Close"],
			appendTo: "#content"
		});
		$('#consoleInputBar input').focus();
	}
	window.scrollToBottomOfConsole = function() {
		var cw = $('#consoleWindow ul.log');
		cw.stop().animate({scrollTop: cw[0].scrollHeight}, 500);
	};

	// helpful function to convert object to string, including function definitions
	// (JSON.stringify doesn't do this, because functions can't be sent by JSON)
	function toJSONWithFuncs(obj) {
		Object.prototype.toJSON = function() {
		var sobj = {}, i;
		for (i in this) 
			if (this.hasOwnProperty(i))
				sobj[i] = typeof this[i] == 'function' ? this[i].toString() : this[i];
  	        return sobj;
      		};
		var str = JSON.stringify(obj);
		delete Object.prototype.toJSON;
		return str;
	}

	if (runningInBrowser) UI.addToLog = function(m,c) { };

	var addToConsoleRaw = function(m) {
		$('#consoleWindow ul.log').append(m);
		scrollToBottomOfConsole(); 
	};

	window.addToConsole = function(m,c) {
		if ("undefined" == typeof(c)) c="log";
		if ("string" != typeof(m)) m=toJSONWithFuncs(m);
		UI.addToLog(m,c);   // send it back to the engine, so we can log it
		//addToConsoleRaw("<li class='"+c+"'>"+$('<div/>').text(m).html()+"</li>"); // escape it (so that < and > show up)
		addToConsoleRaw("<li class='"+c+"'>"+m+"</li>"); // escape it (so that < and > show up)
	};

	// Hijack javascript console to also print to ours
	(function(){
		var oldLog = console.log;
		console.log = function (message) {
			addToConsole(message,"log");
			oldLog.apply(console, arguments);
		};
		var oldError = console.error;
		console.error = function(message) {
			addToConsole(message,"error");
			oldError.apply(console, arguments);
		};
		var oldWarning = console.warn;
		console.warn = function(message) {
			addToConsole(message,"warning");
			oldWarning.apply(console, arguments);
		};
		var oldInfo = console.info;
		console.info = function(message) {
			addToConsole(message,"debug");
			oldInfo.apply(console, arguments);
		};
	})();

	// neat history function (press UP in input box to get previous commands)
	UI.consoleInputBuffer = [];
	UI.consoleInputBufferPos = 0;

	$('#consoleInputBar input').keyup(function(e) {
		if (e.which == 13) { // 13==ENTER
			var t = $('#consoleInputBar input').val();
			UI.consoleInputBufferPos = UI.consoleInputBuffer.length;
			UI.consoleInputBuffer[UI.consoleInputBufferPos++] = t;
			console.log("> " + t);
			$('#consoleInputBar input').val("");
			//console.log("Evaling " + t);
			try {
				r = window.eval(t);
			//	if ("undefined" != typeof(r)) 
					console.log("< " + toJSONWithFuncs(r));
			} catch (e) {
				console.error(e.message);
			}
			//eval(t);
		} else if (e.which == 38) { // 38 == UP
			if (UI.consoleInputBufferPos > 0) UI.consoleInputBufferPos--;
			$('#consoleInputBar input').val(UI.consoleInputBuffer[UI.consoleInputBufferPos]);
		} else if (e.which == 40) { // 40 == DOWN
			if (UI.consoleInputBufferPos < UI.consoleInputBuffer.length)
				UI.consoleInputBufferPos++;
			// you can go 'off the end' of the array (and get a blank line)
			if (UI.consoleInputBufferPos < UI.consoleInputBuffer.length) {
				$('#consoleInputBar input').val(UI.consoleInputBuffer[UI.consoleInputBufferPos]);
			} else 
				$('#consoleInputBar input').val("");
		}
	});

	// might make this a bit prettier at some point
	UI.history = function() { console.log(UI.consoleInputBuffer); }
	
	// if we're running in the engine, grab all saved console messages and display them
	// (the engine saves all messages while we're loading)
	if (runningInBrowser) {
		console.log("We're running in a browser, adding some dummy text here...");
		for (i=0;i<100;++i) console.log("blah " + i);
		console.log("See also <a href='../../windfall_log.html'>log file</a>");
		UI.Quit = function() { alert("Quitting now.   ooops, no I'm not."); };
	} else
		UI.popBackBuffer();
});
</script>

</body>
</html>
